/**
 * @author Marco Arci (marco.arci@webresults.it)
 * @date 23/07/2021
 * @description HDT_LC_ActivityDetail - Classe(query) chiamata da hdtActivityDetail
 * @history Inserire Nome Cognome – Data Modifica – Descrizione della modifica
 */
public with sharing class HDT_LC_ActivityDetail {
    class ObjectFieldData{
        @AuraEnabled public Id objectId {get; set;}
        @AuraEnabled public list<wrts_prcgvr__DynamicField__c> fieldList {get; set;}

        ObjectFieldData(){}
    }

    @AuraEnabled
    public static map<string,ObjectFieldData> getObjectFields(Id idActivity){

        map<string,ObjectFieldData> objectFields= new Map<String,ObjectFieldData>();

        wrts_prcgvr__Activity__c activity = [SELECT Id, wrts_prcgvr__ActivityTemplate__c, Order__c, Case__c FROM wrts_prcgvr__Activity__c WHERE Id=:idActivity limit 1]; 
        list<wrts_prcgvr__ActivityTemplate__c> activityTemplate = [SELECT Id, wrts_prcgvr__FieldsTemplate__c FROM wrts_prcgvr__ActivityTemplate__c WHERE Id=:activity.wrts_prcgvr__ActivityTemplate__c];
        list<wrts_prcgvr__FieldsTemplate__c> fieldsTemplate = [SELECT Id FROM wrts_prcgvr__FieldsTemplate__c WHERE Id=:activityTemplate[0].wrts_prcgvr__FieldsTemplate__c];
        list<wrts_prcgvr__DynamicSection__c> dynamicSection = [SELECT Id, wrts_prcgvr__Layout__c FROM wrts_prcgvr__DynamicSection__c WHERE wrts_prcgvr__Layout__c IN: fieldsTemplate];
        list<wrts_prcgvr__DynamicField__c> dynamicField = [SELECT Id, wrts_prcgvr__Section__c, wrts_prcgvr__ObjectName__c, wrts_prcgvr__Field__c FROM wrts_prcgvr__DynamicField__c WHERE wrts_prcgvr__Section__c IN: dynamicSection];
        for(wrts_prcgvr__DynamicField__c field: dynamicField){
            if(!objectFields.keyset().contains(field.wrts_prcgvr__ObjectName__c)){
                ObjectFieldData wrp = new ObjectFieldData();
                if(field.wrts_prcgvr__ObjectName__c=='wrts_prcgvr__Activity__c'){
                    wrp.objectId = (Id)activity.get('id');
                }else{
                    if(  field.wrts_prcgvr__ObjectName__c=='Order'){
                        wrp.objectId = (Id)activity.get('Order__c');
                    }else if(field.wrts_prcgvr__ObjectName__c=='Case'){
                        wrp.objectId = (Id)activity.get('Case__c');
                    }
                }
                wrp.fieldList = new list<wrts_prcgvr__DynamicField__c>();

                objectFields.put(field.wrts_prcgvr__ObjectName__c,wrp);
            }
            objectFields.get(field.wrts_prcgvr__ObjectName__c).fieldList.add(field);
        }
        system.debug(JSON.serializePretty(objectFields));
        return objectFields;
    }

        /*
        @AuraEnabled
        public static map<string,list<Object>> getDetail(Id idActivity){
            map<string,list<Object>> details= new Map<String,list<Object>>();
            list<wrts_prcgvr__Activity__c> activity=[SELECT Id, wrts_prcgvr__ActivityTemplate__c FROM wrts_prcgvr__Activity__c WHERE Id=:idActivity];
            details.put('activity',activity);
            list<wrts_prcgvr__ActivityTemplate__c> activityTemplate=[SELECT Id, wrts_prcgvr__FieldsTemplate__c FROM wrts_prcgvr__ActivityTemplate__c WHERE Id=:activity[0].wrts_prcgvr__ActivityTemplate__c];
            details.put('activityTemplate',activityTemplate);
            list<wrts_prcgvr__FieldsTemplate__c> fieldsTemplate=[SELECT Id FROM wrts_prcgvr__FieldsTemplate__c WHERE Id=:activityTemplate[0].wrts_prcgvr__FieldsTemplate__c];
            details.put('fieldsTemplate',fieldsTemplate);
            list<wrts_prcgvr__DynamicSection__c> dynamicSection=[SELECT Id, wrts_prcgvr__Layout__c FROM wrts_prcgvr__DynamicSection__c WHERE wrts_prcgvr__Layout__c IN: fieldsTemplate];
            details.put('dynamicSection',dynamicSection);
            list<wrts_prcgvr__DynamicField__c> dynamicField=[SELECT Id, wrts_prcgvr__Section__c, wrts_prcgvr__ObjectName__c, wrts_prcgvr__Field__c FROM wrts_prcgvr__DynamicField__c WHERE wrts_prcgvr__Section__c IN: dynamicSection];
            details.put('dynamicField',dynamicField);
            system.debug(details);
            return details;
        }
        */
        /*
        @AuraEnabled
        public static map<id,list<Object>> getSectionsFields(id fieldsTemplate){
            list<Object> vett= new list<Object>();
            map<id,list<Object>> sectionsFields= new map<id,list<Object>>();
            list<object> listSections= [SELECT Id, wrts_prcgvr__Layout__c FROM wrts_prcgvr__DynamicSection__c WHERE wrts_prcgvr__Layout__c =: fieldsTemplate];
            set<id> idSec= new set<id>();
            for(object var: listSections){
                idSec.add(var.id);
            }
            list<object> listFields= [SELECT Id, wrts_prcgvr__Section__c, wrts_prcgvr__Field__c FROM wrts_prcgvr__DynamicField__c WHERE wrts_prcgvr__Section__c IN: idSec];
            for(id idSec: listSections){
                for(object fie: listFields){
                    if(fie.wrts_prcgvr__Section__c==sec.Id){
                        vett.add(fie);
                    }
                }
                sectionsFields.push(sec.Id,vett);
                vett.clear();
            }
            return sectionsFields;
        }
        */
}
public with sharing class HDT_SRV_DocumentSelectedManager {
    @InvocableMethod(label='Manage Document Selected')
    public static List<HDT_WRP_DocumentSelectedResponse> execute(List<HDT_WRP_DocumentSelectedRequest> inputs){
        if(inputs==null || inputs.size()<=0 || String.isBlank(inputs[0].recordId) || String.isBlank(inputs[0].method)) return null;
        String method = inputs[0].method;
        switch on method{
            when 'manageDocuments' {
                return manageDocuments(inputs);
            }
            when else {
                return null;
            }
        }
    }

    private static List<HDT_WRP_DocumentSelectedResponse> manageDocuments(List<HDT_WRP_DocumentSelectedRequest> inputs){
        if(inputs==null || inputs.size()<=0 || String.isBlank(inputs[0].recordId)) return null;
        HDT_WRP_DocumentSelectedResponse response = new HDT_WRP_DocumentSelectedResponse();
        List<HDT_WRP_DocumentSelectedResponse> responseList = new List<HDT_WRP_DocumentSelectedResponse>();
        try {
            String queryString = 'SELECT Id, DocumentSelected__c FROM ServiceCatalog__c WHERE Id=\''+inputs[0].recordId+'\'';
            String fromQ = 'ServiceCatalog__c';
            List<SObject> recordList = HDT_QR_GenericQuery.getGenericRecords(queryString, fromQ);
            String documentJSON = (String) recordList[0].get('DocumentSelected__c');
            List<Object> primoLivelloList = (List<Object>)JSON.deserializeUntyped(documentJSON);
            Map<String,Object> primolivello = (Map<String, Object>)primoLivelloList[0];
            List<Object> secondoLivelloList = (List<Object>)primolivello.get('secondoLivelloInformativo');
            Map<String, Object> secondoLivello = (Map<String, Object>)secondoLivelloList[0];
            
            Case caseRecord = new Case();
            
            Date dataEmissione = formatDate((String) primolivello.get('dataEmissione'));
            Date dataScadenza = formatDate((String) primolivello.get('dataScadenza'));
            
            String numeroDocumento = (String) primolivello.get('numeroDocumento');
            String numeroFattura = (String) primolivello.get('numeroFattura');
            String contractCode = (String) secondoLivello.get('contratto');

            caseRecord.ContractAccountCode__c = (String) primolivello.get('contoContrattuale');
            caseRecord.DocumentExpirationDate__c = dataScadenza;
            caseRecord.DocumentPaymentMethod__c = (String) primolivello.get('modalitaPagamento');
            caseRecord.DocumentResidue__c = Double.valueOf(primolivello.get('residuo'));
            caseRecord.DocumentAmount__c = Double.valueOf(secondoLivello.get('importo'));
            caseRecord.Amount__c = Double.valueOf(primolivello.get('importo'));
            caseRecord.BillNumber__c = numeroFattura != null? numeroFattura:numeroDocumento;
            caseRecord.Id = inputs[0].caseId;
            //caseRecord.ReadType__c = (String) secondoLivello.get('importo'); --> Richiamare WS ad hoc
            
            response.caseRecord = caseRecord;
            response.contractCode = contractCode;

            if(inputs[0].createDocuments){
                List<DocumentSelected__c> documentList = new List<DocumentSelected__c>();
                DocumentSelected__c singleDocument = new DocumentSelected__c();
                for(Object singleRecord : primoLivelloList){
                    primolivello = (Map<String, Object>) singleRecord;
                    secondoLivelloList = (List<Object>)primolivello.get('secondoLivelloInformativo');
                    numeroDocumento = (String) primolivello.get('numeroDocumento');
                    numeroFattura = (String) primolivello.get('numeroFattura');
                    dataEmissione = formatDate((String) primolivello.get('dataEmissione'));
                    dataScadenza = formatDate((String) primolivello.get('dataScadenza'));
                    Double totaleCopertina = Double.valueOf(primolivello.get('totaleCopertina'));
                    Double importo = Double.valueOf(primolivello.get('importo'));
                    singleDocument.DocumentNumber__c = numeroFattura != null? numeroFattura:numeroDocumento;
                    singleDocument.Bill__c = (String) primolivello.get('numeroBollettino');
                    singleDocument.Type__c = (String) primolivello.get('tipoDocumento');
                    singleDocument.IssueDate__c = dataEmissione;
                    singleDocument.ExpirationDate__c = dataScadenza;
                    singleDocument.Amount__c = totaleCopertina != null? totaleCopertina:importo;
                    //singleDocument.Residue__c = (String) primolivello.get('residuo');
                    singleDocument.Extension__c = (String) primolivello.get('dilazione');
                    singleDocument.PaymentMode__c = (String) primolivello.get('modalitaPagamento');
                    //singleDocument.TvFeeResidual__c = calculateRaiFee(secondoLivelloList);
                    singleDocument.IssuingCompany__c = (String) primolivello.get('societa');
                    singleDocument.ContractualAccount__c = (String) primolivello.get('contoContrattuale');
                    singleDocument.Case__c = inputs[0].caseId;
                    documentList.add(singleDocument);
                }
                if(documentList.size()>0){
                    Boolean insertDoc = HDT_UTL_DatabaseService.insertSObject(documentList);
                }
            }
            Boolean updateCase = HDT_UTL_DatabaseService.updateSObject(caseRecord);
        } catch (Exception ex) {
            System.debug('Error in HDT_SRV_DocumentSelectedManager: ' + ex.getMessage() + ' at line ' + ex.getLineNumber());
            return null;
        }
        responseList.add(response);
        return responseList;
    }

    private static Date formatDate(String inputDate){
        if(inputDate==null || String.isBlank(inputDate)) return null;
        List<String> listString = inputDate.split('/');
        String gg = listString[0];
        String mm = listString[1];
        String yyyy = listString[2];
        return Date.valueOf(yyyy+'-'+mm+'-'+gg);
    }

    private static String calculateRaiFee(List<Object> secondoLivelloList){
        if(secondoLivelloList==null || secondoLivelloList.size()<=0) return null;
        try {
            Double raiFee = 0;
            for(Object singleRecord : secondoLivelloList){
                Map<String, Object> secondolivello = (Map<String, Object>) singleRecord;
                String tipoDocumento = (String) secondolivello.get('tipoDocumento');
                String motivoPareggio = (String) secondolivello.get('motivoDiPareggio');
                Double importo = Double.valueOf(secondolivello.get('importo'));
                if(tipoDocumento.equalsIgnoreCase('VR') && (String.isBlank(motivoPareggio) || String.isEmpty(motivoPareggio))){
                    raiFee += importo;
                }
            }
            return String.valueOf(raiFee);
        } catch (Exception ex) {
            System.debug('Error in HDT_SRV_DocumentSelectedManager: ' + ex.getMessage());
            return null;
        }
    }

    public class HDT_WRP_DocumentSelectedResponse{
    
        @InvocableVariable
        public Case caseRecord;
        
        @InvocableVariable
        public String contractCode;
        
        @InvocableVariable
        public List<DocumentSelected__c> documents;
        
    }

    public class HDT_WRP_DocumentSelectedRequest{
        @InvocableVariable
        public String recordId;

        @InvocableVariable
        public String caseId;
        
        @InvocableVariable
        public Boolean createDocuments;

        @InvocableVariable
        public String method;

        @InvocableVariable
        public String contractCode;
    }
    
}
